name: Sync manual tests to Qase

on:
  push:
    paths:
      - "docs/manual-testing/tests/*.json"
  workflow_dispatch:
    inputs:
      suite:
        description: "Only this suite name optional"
        required: false
      external_ids:
        description: "Comma separated external IDs optional"
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute changed JSON files
        if: github.event_name == 'push'
        id: diff
        run: |
          BASE="${{ github.event.before }}"
          if [ -z "$BASE" ]; then BASE=$(git rev-list --max-parents=0 HEAD | tail -n1); fi
          FILES=$(git diff --name-only "$BASE" HEAD -- docs/manual-testing/tests/*.json || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install requests

      - name: Debug Qase project access
        env:
          QASE_API_TOKEN: ${{ secrets.QASE_API_TOKEN }}
          QASE_PROJECT: LUMISO
        run: |
          python - << 'PY'
          import os, requests
          base = "https://api.qase.io/v1"
          proj = os.environ["QASE_PROJECT"]
          tok  = os.environ["QASE_API_TOKEN"]
          h = {"Token": tok}
          r = requests.get(f"{base}/project/{proj}", headers=h)
          print("GET /project status:", r.status_code)
          print("GET /project body:", r.text[:300])
          r2 = requests.get(f"{base}/suite/{proj}?limit=5&offset=0", headers=h)
          print("GET /suite status:", r2.status_code)
          print("GET /suite body:", r2.text[:300])
          PY

      - name: Sync to Qase and open run
        env:
          QASE_API_TOKEN: ${{ secrets.QASE_API_TOKEN }}
          QASE_PROJECT: LUMISO
          CHANGED_FILES: ${{ github.event_name == 'push' && steps.diff.outputs.files || '' }}
          RUN_SUITE: ${{ inputs.suite }}
          RETEST_IDS: ${{ inputs.external_ids }}
        run: python scripts/qase_sync.py
