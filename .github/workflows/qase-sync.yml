name: Sync manual tests to Qase

on:
  push:
    paths:
      - "docs/manual-testing/tests/*.json"
  workflow_dispatch:
    inputs:
      suite:
        description: "Only this suite name optional"
        required: false
      external_ids:
        description: "Comma separated external IDs optional"
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute changed JSON files
        id: diff
        run: |
          BASE="${{ github.event.before }}"
          if [ -z "$BASE" ]; then BASE=$(git rev-list --max-parents=0 HEAD | tail -n1); fi
          FILES=$(git diff --name-only "$BASE" HEAD -- docs/manual-testing/tests/*.json || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install requests

      - name: Sync to Qase and open run
        env:
          QASE_API_TOKEN: ${{ secrets.QASE_API_TOKEN }}
          QASE_PROJECT: CRM
          CHANGED_FILES: ${{ steps.diff.outputs.files }}
          RUN_SUITE: ${{ inputs.suite }}
          RETEST_IDS: ${{ inputs.external_ids }}
        run: python scripts/qase_sync.py
