# Auth Support Playbook

This playbook gives Support enough detail to debug customer-facing auth issues while we finish the remaining hardening phases.

## 1. Signals & Monitoring

- **Frontend telemetry** — Every auth action emits events (`auth_sign_in_start`, `auth_reset_request_success`, `auth_password_update_error`, etc.) via `trackEvent`. In PostHog/Sentry, filter for events whose `source` property is `auth-ui`.  
- **Password emails** — Recovery, sign‑up confirmation, and password-change notifications are sent by the `send-template-email` edge function using Resend. Each successful send logs to the `notification_logs`/`email_logs` tables with metadata that includes intent + recipient.
- **Console traces** — When debugging locally, enable dev tooling and watch for `[auth-event]` logs in the browser console or “Auth email” messages in the Supabase function logs (`supabase functions logs send-template-email`).
- **In-browser breadcrumbs** — On any environment you can run `window.__lumisoAuthEvents` in DevTools to inspect the last ~50 auth events (timestamp + redacted payload). This is powered by `src/lib/authTelemetry.ts`.

## 2. Customer Verification Checklist

Before triggering manual actions, collect:

1. Email address (must match Supabase auth record).  
2. Whether the user tried recovery or sign-up in the last hour.  
3. Browser + approximate timestamp (helps when correlating telemetry).  
4. Screenshot or wording of the error message they saw.

## 3. Resending a Password Recovery Email

1. Ask the user to start from `/auth` and request a new link so telemetry captures the attempt.  
2. If they still don’t receive it, run the Supabase admin link generator locally:
   ```bash
   npx supabase functions invoke send-template-email \
     --project-ref rifdykpdubrowzbylffe \
     --no-verify-jwt \
     --body '{"authIntent":"password_recovery","email":"user@example.com","locale":"en","redirectTo":"https://app.lumiso.com/auth/recovery"}'
   ```
3. Confirm the customer received the new email and remind them the link expires in 60 minutes.  
4. Record the telemetry event ID (if available) in the support ticket for traceability.

## 4. Resending a Sign-Up Confirmation Email

1. Ensure the user has already run the sign-up flow (Supabase must have the pending user).  
2. Trigger a resend using the same edge function:
   ```bash
   npx supabase functions invoke send-template-email \
     --project-ref rifdykpdubrowzbylffe \
     --no-verify-jwt \
     --body '{"authIntent":"signup_confirmation","email":"user@example.com","locale":"en","redirectTo":"https://app.lumiso.com/auth?mode=confirmed"}'
   ```
3. Remind the user to click the button in the email; the action link is generated by Supabase and respects the redirect you pass in the payload.

## 5. Disabling Supabase Stock Emails (one-time)

To avoid duplicate messages:

1. Open the Supabase dashboard → Authentication → Email Templates.  
2. Disable the built-in confirmation/recovery templates or replace their content with a short note directing users to contact support (we rely on Resend now).  
3. Confirm environment variables `SITE_URL`, `RESEND_API_KEY`, and `SUPABASE_SERVICE_ROLE_KEY` are set in every deployment target before disabling the defaults.  
4. Send yourself a recovery + sign-up test to confirm only the branded email arrives.

## 6. Common Recovery Issues

| Symptom | Likely Cause | Resolution |
| --- | --- | --- |
| Link redirects to dashboard instantly | User already authenticated; instruct them to sign out or use a private window, or ask Support to send another link. | Recovery intent already handles this, but cached sessions may require clearing local storage. |
| “Link expired” message | Supabase tokens expire after 60 minutes or once used. | Generate a fresh link via the playbook command and remind the user to complete the flow immediately. |
| No email received | Corporate spam filters, Supabase defaults still enabled, or wrong email. | Verify telemetry for `auth_reset_request_success`, check email spelling, and ask IT to safelist `updates.lumiso.app`. |

## 7. Escalation Path

1. If the Supabase admin API fails, capture the error payload and rerun with `--debug` to surface HTTP traces.  
2. If Resend returns a 4xx/5xx response, retry once and then escalate to Platform with the message ID.  
3. For suspicious activity (multiple resets in a short period), revoke the session from the Supabase dashboard and notify Security.

Keep this document alongside `docs/auth-hardening-plan.md` and update it every time we change auth flows or telemetry destinations.
